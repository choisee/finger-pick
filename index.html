<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>최후의 손가락</title>
    <style>
      body,
      html {
        width: 100%;
        height: 100%;
        margin: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: white;
        overflow: hidden;
      }

      #gameArea {
        width: 100%;
        height: 100%;
        position: relative;
        background-color: black;
      }

      .touchHighlight {
        position: absolute;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background-color: rgba(255, 0, 0, 0.5);
        pointer-events: none;
      }

      .hidden {
        display: none;
      }

      /* Fireworks animation */
      @keyframes fireworks {
        0% {
          transform: scale(0);
          opacity: 1;
        }
        50% {
          transform: scale(1.5);
          opacity: 0.7;
        }
        100% {
          transform: scale(3);
          opacity: 0;
        }
      }

      .firework1 {
        position: absolute;
        width: 10px;
        height: 10px;
        background-color: #ff0;
        border-radius: 50%;
        animation: fireworks 1s ease-out forwards;
      }
      .firework2 {
        position: absolute;
        width: 10px;
        height: 10px;
        background-color: #ff0;
        border-radius: 50%;
        animation: fireworks 2s ease-out forwards;
      }
      .firework3 {
        position: absolute;
        width: 10px;
        height: 10px;
        background-color: #ff0;
        border-radius: 50%;
        animation: fireworks 2s ease-out forwards;
      }

      .firework1:nth-child(even) {
        background-color: peru;
      }

      .firework2:nth-child(odd) {
        background-color: #0f0;
      }
      #timerDisplay {
        position: absolute;
        top: 0;
        margin: 0 auto;
        font-size: 25px;
        font-weight: bold;
        color: #333;
        background-color: rgba(255, 255, 255, 0.8);
        padding: 5px;
        border-radius: 10px;
      }
      #timerDisplay.hidden {
        display: none;
      }
      /* Reset Button Styling */
      #resetButton {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 20px;
        padding: 10px 20px;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      #resetButton:hover {
        background-color: #45a049;
      }
    </style>
  </head>

  <body>
    <div id="gameArea"></div>
    <div id="fireworks" class="hidden"></div>
    <div id="timerDisplay">0:03</div>
    <!-- update with WAIT_FINGER -->
    <button id="resetButton" class="hidden">다시하기</button>

    <script>
      // Select the game area (the screen)
      const gameArea = document.getElementById("gameArea");
      const fireworksContainer = document.getElementById("fireworks");
      const timerDisplay = document.getElementById("timerDisplay");
      const resetButton = document.getElementById("resetButton");

      let touches = []; // Store active touches
      let timeoutID = null; // Timeout to track inactivity
      let isGameActive = true; // Flag to control game activity (whether touches are allowed or not)
      let WAIT_FINGER = 3; // sec - find "update with WAIT_FINGER"
      let timerValue = WAIT_FINGER; // 5 minutes in seconds (300s)
      let timerInterval = null; // Store the timer interval

      // Function to highlight touched areas
      function highlightTouch(touch) {
        const touchElement = document.createElement("div");
        touchElement.classList.add("touchHighlight");

        // Set the position of the highlight based on the touch location
        touchElement.style.left = `${touch.clientX - 25}px`; // Centered on the touch
        touchElement.style.top = `${touch.clientY - 25}px`;

        // Append it to the game area
        gameArea.appendChild(touchElement);

        // Add this touch to the active touches array
        touches.push(touchElement);

        // Clear previous timeout and set a new one to check for inactivity
        if (timeoutID) {
          clearTimeout(timeoutID);
          timerValue = WAIT_FINGER + 1;
          updateTimer();
        }

        // Wait for 1 second after the last touch before starting to randomly remove highlights
        timeoutID = setTimeout(() => {
          // Start the interval to remove highlights randomly after 1 second
          startRandomHighlightRemoval();
        }, 1000 * WAIT_FINGER);
      }

      // Function to start removing highlights randomly
      function startRandomHighlightRemoval() {
        isGameActive = false; // Disable further touch events
        // Hide the timer display during this phase
        timerDisplay.classList.add("hidden");

        let interval = setInterval(() => {
          // If there is only 1 touch left, stop removing and trigger fireworks
          if (touches.length === 1) {
            clearInterval(interval);
            triggerFireworks();
            return;
          }
          // Randomly pick an index from the active touches
          const randomIndex = Math.floor(Math.random() * touches.length);
          const touchToRemove = touches[randomIndex];

          // Fade out the random touch highlight
          touchToRemove.style.opacity = "0";

          // Remove it from the touches array and DOM after fading
          setTimeout(() => {
            gameArea.removeChild(touchToRemove);
            touches.splice(randomIndex, 1); // Remove from the touches array
          }, 500); // Wait a bit to allow fade-out before removing it
        }, 1000); // Remove one highlight every 1 second
      }

      // Function to trigger fireworks animation
      function triggerFireworks() {
        fireworksContainer.classList.remove("hidden");
        fireworksContainer.innerHTML = ""; // Clear any previous fireworks

        // Create 3 fireworks
        createFireworks(10, 0);

        // Create 2 fireworks after 1 second
        setTimeout(() => createFireworks(8, 300), 300);

        // Create 5 fireworks after 2 seconds
        setTimeout(() => createFireworks(12, 200), 200);

        // Show the reset button after fireworks finish
        setTimeout(() => {
          resetButton.classList.remove("hidden");
        }, 500); // Show after fireworks animation ends (3 seconds)
      }

      // Function to create a group of fireworks
      function createFireworks(count, delay) {
        for (let i = 0; i < count; i++) {
          console.log("test - count : ", count);
          const firework = document.createElement("div");
          firework.classList.add("firework" + (i % 3));

          // Random position and animation timing for fireworks
          firework.style.left = `${Math.random() * window.innerWidth}px`;
          firework.style.top = `${Math.random() * window.innerHeight}px`;

          // Add firework to the container with a delay for each
          setTimeout(() => {
            fireworksContainer.appendChild(firework);
          }, delay + i * 100); // Delay each firework slightly (100ms apart)
        }

        // Hide fireworks after animation completes
        setTimeout(() => {
          fireworksContainer.classList.add("hidden");
        }, delay + 3000); // Hide after 3 seconds from last firework
      }

      // Function to update the timer display
      function updateTimer() {
        if (timerValue <= 0) {
          clearInterval(timerInterval); // Stop the timer once it's 0
          if (touches.length === 0) {
            // Disable touch events and show reset button when the timer hits 0:00
            isGameActive = false;
            resetButton.classList.remove("hidden"); // Show the reset button
          }
          return;
        }

        // Update the timer value (subtract 1 second each time)
        timerValue--;

        // Convert timer value into minutes and seconds format
        const minutes = Math.floor(timerValue / 60);
        const seconds = timerValue % 60;
        timerDisplay.textContent = `${minutes}:${
          seconds < 10 ? "0" : ""
        }${seconds}`;
      }

      // Start the Pomodoro-like timer
      timerInterval = setInterval(updateTimer, 1000);
      //   // Start the Pomodoro-like timer
      //   let timerInterval = setInterval(updateTimer, 1000);

      // Track touch start event
      gameArea.addEventListener("touchstart", (e) => {
        e.preventDefault(); // Prevent default scrolling/zoom behavior

        // Only proceed if the number of touches is less than or equal to the maximum allowed
        if (touches.length < 10 && isGameActive) {
          const touch = e.changedTouches[0]; // Get the first touch (for simplicity, we use only one touch)
          highlightTouch(touch);
        }
      });

      // Track touch move event
      gameArea.addEventListener("touchmove", (e) => {
        // Prevent default scroll/zoom behavior
        e.preventDefault();
        // Optionally, track touch moves if necessary
      });

      // Track touch end event (remove the touch highlight)
      gameArea.addEventListener("touchend", (e) => {
        e.preventDefault();
        // For simplicity, we don't handle touch end explicitly here
      });

      // Reset Game to start a new round
      resetButton.addEventListener("click", resetGame);

      function resetGame() {
        // Clear all touch highlights and reset variables
        touches.forEach((touch) => gameArea.removeChild(touch));
        touches = [];

        // Reset game state variables
        isGameActive = true;
        timerValue = WAIT_FINGER;
        timerDisplay.textContent = "0:03"; // update with WAIT_FINGER
        timerDisplay.classList.remove("hidden");

        // Hide the reset button and restart the timer
        resetButton.classList.add("hidden");
        clearInterval(timerInterval);
        timerInterval = setInterval(updateTimer, 1000);

        // Reset fireworks container
        fireworksContainer.classList.add("hidden");
        timeoutID = null; // Timeout to track inactivity
      }
    </script>
  </body>
</html>
